#!/usr/bin/env python
# -*- coding: utf-8 -*-

import argparse

try:
    # noinspection PyUnresolvedReferences
    import shaibos
except ImportError:
    import sys
    import os

    sys.path.append(os.path.join(os.path.dirname(os.path.realpath(__file__)), '../'))

    # noinspection PyUnresolvedReferences
    import shaibos

from shaibos.load.from_yaml import load_invoices_from_yaml_file
from shaibos.tax.rates import default_income_type_code, evrk_code_to_activity_type_code
from shaibos.tax.totals import buyer_totals, gpm_percentages, activity_totals, tax_totals, invoice_totals
from shaibos.util.log import get_logger

# ---

logger = get_logger()


def tax_filing(invoices, year):
    for invoice_number_prefix in invoices:
        for invoice in invoices[invoice_number_prefix]:
            totals_per_invoice = invoice_totals(invoice=invoice, year=year)
            if totals_per_invoice is None:
                continue
            logger.info("%s: %s" % (invoice, totals_per_invoice))
    logger.info("")

    gpm = gpm_percentages(invoices=invoices)

    totals_by_buyer = buyer_totals(invoices=invoices, year=year)
    logger.info("TOTALS by buyer:")
    for buyer_id, buyer_total in totals_by_buyer.items():
        logger.info("* %s: %s" % (buyer_id, buyer_total))
    logger.info("")

    totals_by_activity = activity_totals(invoices=invoices, year=year)
    logger.info("TOTALS by activity:")
    for evrk_code, activity_total in totals_by_activity.items():
        logger.info("* %d (GPM %d%%): %s" % (evrk_code, gpm[evrk_code], activity_total))
    logger.info("")

    totals = tax_totals(invoices=invoices, year=year)
    logger.info("TOTAL¹:")
    logger.info(" * %s" % totals)
    logger.info(
        "¹ Might be different from the sum of all invoices because expenses are counted for each activity separately.")
    logger.info("")

    logger.info("---")
    logger.info("")

    logger.info('GPM308V (Individualios veiklos pajamos):')
    logger.info("")

    logger.info("6 (Mokestinis laikotarpis): %d" % year)
    logger.info("")

    for evrk_code, activity_total in totals_by_activity.items():
        logger.info("* V1 (Pajamų rūšies kodas): %d" % default_income_type_code())
        logger.info("  V2 (Veiklos rūšies kodas): %d" % evrk_code_to_activity_type_code(evrk_code))
        logger.info("  V3 (Valstybių skaičius): %d" % activity_total.country_count)
        logger.info("  V4 (Valstybės kodas): ")
        logger.info("  V5 (GPM tarifas): %d" % gpm[evrk_code])
        logger.info("  V6 (Pajamų suma): %2.2f" % activity_total.income)
        logger.info("  V7 (Leidžiamų atskaitymų suma): %2.2f" % activity_total.expenses)
        logger.info("  V8 (Pajamų suma (+)/mokestinio laikotarpio nuostolių suma (-)): %2.2f" % activity_total.tax_base)
        logger.info("  V9 (Atskaitoma ankstesnių mokestinių nuostolių suma): 0")
        logger.info("  ")

    logger.info("V11 (Išskaičiuota pajamų mokesčio suma): 0")
    logger.info("V12 (Išskaičiuota PSDĮ suma): 0")
    logger.info("VA (Taikomas apskaitos principas): Pinigų")
    logger.info("")

    logger.info("---")
    logger.info("")

    logger.info('Mokesčiai:')
    logger.info("")

    logger.info("GPM:")
    logger.info("* Įmokos kodas: 1441")
    logger.info("* Sąskaita: http://www.vmi.lt/cms/biudzeto-pajamu-surenkamoji-saskaita")
    logger.info("* Suma: apskaičiuota deklaracijos antrajame puslapyje, 33 laukelyje")
    logger.info("")

    logger.info("VSD:")
    logger.info("* Įmokos kodas: 292")
    logger.info("* Sąskaita: http://www.sodra.lt/surenkamosios-saskaitos")
    logger.info("* Suma: %2.2f" % totals.vsd)
    logger.info("")

    logger.info("PSD:")
    logger.info("* Įmokos kodas: 343")
    logger.info("* Sąskaita: http://www.sodra.lt/surenkamosios-saskaitos")
    logger.info("* Suma: %2.2f minus per mokestinius metus kas mėnesį sumokėtos įmokos" % totals.psd)


if __name__ == "__main__":
    parser = argparse.ArgumentParser(description='Print tax filing information for invoices.')
    parser.add_argument('-i', '--input_yaml', type=str, required=True, help='YAML file with invoices')
    parser.add_argument('-y', '--year', type=int, required=True, help='Year for which to print filing information')
    args = parser.parse_args()

    yaml_invoices = load_invoices_from_yaml_file(args.input_yaml)
    tax_filing(invoices=yaml_invoices, year=args.year)
